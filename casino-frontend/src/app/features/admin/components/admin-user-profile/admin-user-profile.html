<div class="user-profile-page">

  <!-- Barra superior com bot√£o de voltar -->
  <div class="page-top-bar">
    <button class="back-btn" (click)="goBack()">
      ‚Üê Voltar para Usu√°rios
    </button>
    <h1 class="page-title">Perfil do Usu√°rio</h1>
  </div>

  <!-- Loading -->
  @if (isLoading) {
    <div class="loading-container">
      <div class="loading-spinner"></div>
      <p>Carregando perfil...</p>
    </div>
  }

  <!-- Conte√∫do do perfil -->
  @if (!isLoading && profileData) {
    <div class="profile-content">

      <!-- ===== COLUNA ESQUERDA ===== -->
      <div class="profile-left">

        <!-- Card do usu√°rio -->
        <div class="card user-card">
          <div class="user-card-header">
            <div class="profile-avatar">
              {{ getInitials(profileData.user) }}
            </div>
            <div class="profile-info">
              <h2>{{ profileData.user.firstName }} {{ profileData.user.lastName }}</h2>
              <span class="profile-username">&#64;{{ profileData.user.username }}</span>
              <div class="profile-badges">
                <span class="role-badge" [class.role-admin]="profileData.user.role === 'admin'">
                  {{ profileData.user.role === 'admin' ? 'üëë Admin' : 'üéÆ Jogador' }}
                </span>
                <span class="status-badge" [ngClass]="getStatusClass(profileData.user)">
                  {{ getUserStatusBadge(profileData.user) }}
                </span>
              </div>
            </div>
          </div>

          <!-- A√ß√µes r√°pidas -->
          <div class="quick-actions">
            <button class="btn-action edit" (click)="openEditModal()">
              ‚úèÔ∏è Editar
            </button>
            <button class="btn-action add" (click)="openBalanceModal('add')">
              üí∞+ Adicionar Saldo
            </button>
            <button class="btn-action remove" (click)="openBalanceModal('remove')">
              üí∞- Remover Saldo
            </button>
            <button class="btn-action block" (click)="toggleUserStatus()">
              {{ profileData.user.isActive ? 'üîí Bloquear' : 'üîì Desbloquear' }}
            </button>
          </div>
        </div>

        <!-- Informa√ß√µes b√°sicas -->
        <div class="card">
          <h3 class="card-title">üìã Informa√ß√µes</h3>
          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">Email</span>
              <span class="info-value">{{ profileData.user.email }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Cadastro</span>
              <span class="info-value">{{ profileData.user.createdAt | date: 'dd/MM/yyyy HH:mm' }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">√öltimo Login</span>
              <span class="info-value">
                {{ profileData.user.lastLoginAt ? (profileData.user.lastLoginAt | date: 'dd/MM/yyyy HH:mm') : 'Nunca' }}
              </span>
            </div>
            <div class="info-item">
              <span class="info-label">IP do √öltimo Login</span>
              <span class="info-value">{{ profileData.user.lastLoginIp || 'N/A' }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== COLUNA DIREITA ===== -->
      <div class="profile-right">

        <!-- Estat√≠sticas financeiras -->
        <div class="card">
          <h3 class="card-title">üí∞ Estat√≠sticas</h3>
          <div class="stats-grid">
            <div class="stat-card">
              <span class="stat-icon">üíµ</span>
              <span class="stat-value green">{{ profileData.user.balance | appCurrency }}</span>
              <span class="stat-label">Saldo Atual</span>
            </div>
            <div class="stat-card">
              <span class="stat-icon">üéØ</span>
              <span class="stat-value">{{ profileData.stats.totalBets }}</span>
              <span class="stat-label">Total de Apostas</span>
            </div>
            <div class="stat-card">
              <span class="stat-icon">üìà</span>
              <span class="stat-value green">{{ profileData.stats.totalWon | appCurrency }}</span>
              <span class="stat-label">Total Ganho</span>
            </div>
            <div class="stat-card">
              <span class="stat-icon">üìâ</span>
              <span class="stat-value red">{{ profileData.stats.totalLost | appCurrency }}</span>
              <span class="stat-label">Total Perdido</span>
            </div>
            <div class="stat-card">
              <span class="stat-icon">üèÜ</span>
              <span class="stat-value gold">{{ profileData.stats.winRate }}</span>
              <span class="stat-label">Taxa de Vit√≥ria</span>
            </div>
            <div class="stat-card">
              <span class="stat-icon">üí∏</span>
              <span class="stat-value">{{ profileData.stats.totalWagered | appCurrency }}</span>
              <span class="stat-label">Total Apostado</span>
            </div>
          </div>
        </div>

        <!-- Transa√ß√µes recentes -->
        <div class="card">
          <h3 class="card-title">üìë Transa√ß√µes Recentes</h3>
          @if (profileData.recentTransactions.length > 0) {
            <div class="transactions-list">
              @for (tx of profileData.recentTransactions; track tx.id || $index) {
                <div class="transaction-item">
                  <div class="tx-icon">{{ getTxIcon(tx.type) }}</div>
                  <div class="tx-info">
                    <span class="tx-desc">{{ tx.description || getTxLabel(tx.type) }}</span>
                    <span class="tx-date">{{ tx.createdAt | date: 'dd/MM/yyyy HH:mm' }}</span>
                  </div>
                  <div class="tx-amount"
                    [class.positive]="isPositiveTx(tx.type)"
                    [class.negative]="!isPositiveTx(tx.type)">
                    {{ isPositiveTx(tx.type) ? '+' : '-' }}{{ tx.amount | appCurrency }}
                  </div>
                </div>
              }
            </div>
          } @else {
            <div class="empty-transactions">
              <p>Nenhuma transa√ß√£o encontrada</p>
            </div>
          }
        </div>
      </div>
    </div>
  }

  <!-- Erro / N√£o encontrado -->
  @if (!isLoading && !profileData) {
    <div class="error-container">
      <h2>üòï Usu√°rio n√£o encontrado</h2>
      <p>N√£o foi poss√≠vel carregar os dados deste usu√°rio.</p>
      <button class="back-btn" (click)="goBack()">‚Üê Voltar para Usu√°rios</button>
    </div>
  }

  <!-- ===== MODAL DE EDI√á√ÉO ===== -->
  @if (showEditModal) {
    <div class="modal-overlay" (click)="closeEditModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Editar Usu√°rio</h2>
          <button class="close-btn" (click)="closeEditModal()">‚úï</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Nome</label>
            <input type="text" [(ngModel)]="editForm.firstName" />
          </div>
          <div class="form-group">
            <label>Sobrenome</label>
            <input type="text" [(ngModel)]="editForm.lastName" />
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" [(ngModel)]="editForm.email" />
          </div>
          <div class="form-group">
            <label>Username</label>
            <input type="text" [(ngModel)]="editForm.username" />
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn-cancel" (click)="closeEditModal()">Cancelar</button>
          <button class="btn-save" (click)="saveUserChanges()">Salvar</button>
        </div>
      </div>
    </div>
  }

  <!-- ===== MODAL DE SALDO ===== -->
  @if (showBalanceModal) {
    <div class="modal-overlay" (click)="closeBalanceModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>{{ balanceForm.operation === 'add' ? 'Adicionar' : 'Remover' }} Saldo</h2>
          <button class="close-btn" (click)="closeBalanceModal()">‚úï</button>
        </div>
        <div class="modal-body">
          @if (profileData) {
            <p class="user-info-text">
              Usu√°rio: <strong>{{ profileData.user.username }}</strong><br>
              Saldo atual: <strong>{{ profileData.user.balance | appCurrency }}</strong>
            </p>
          }
          <div class="form-group">
            <label>Valor</label>
            <input type="number" [(ngModel)]="balanceForm.amount" min="0" step="0.01" />
          </div>
          <div class="form-group">
            <label>Descri√ß√£o (Obrigat√≥ria)</label>
            <textarea [(ngModel)]="balanceForm.description" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn-cancel" (click)="closeBalanceModal()">Cancelar</button>
          <button class="btn-save" (click)="saveBalanceChanges()">
            {{ balanceForm.operation === 'add' ? 'Adicionar' : 'Remover' }}
          </button>
        </div>
      </div>
    </div>
  }
</div>
